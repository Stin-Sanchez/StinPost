<!DOCTYPE html>
<html th:replace="~{fragments/layout :: plantilla(~{::body})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Formulario de Producto</title>
</head>
<body class="bg-light">
<div th:fragment="content">
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0" id="formTitle">Nuevo Producto</h4>
                    </div>

                    <div class="card-body p-4">
                        <div class="mb-3">
                            <a class="btn btn-outline-primary btn-sm" href="/products">Volver</a>
                        </div>

                        <div class="alert alert-danger d-none" id="globalError"></div>

                        <form id="productForm" novalidate>
                            <input id="id" type="hidden">
                            <input id="currentImageUrl" type="hidden">

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="code">Código <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" id="code" maxlength="30" placeholder="Ej: PROD-001"
                                           type="text"/>
                                    <div class="invalid-feedback" id="error-code"></div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="nameProducto">Nombre <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" id="nameProducto" maxlength="100"
                                           placeholder="Nombre del producto" type="text"/>
                                    <div class="invalid-feedback" id="error-nameProducto"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" for="description">Descripción <span
                                        class="text-danger">*</span></label>
                                <textarea class="form-control" id="description" maxlength="200"
                                          placeholder="Descripción del producto" rows="3"></textarea>
                                <div class="invalid-feedback" id="error-description"></div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label" for="marca">Marca <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" id="marca" maxlength="50" placeholder="Marca"
                                           type="text"/>
                                    <div class="invalid-feedback" id="error-marca"></div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label" for="price">Precio <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" id="price" min="0" placeholder="0.00" step="0.01"
                                           type="number"/>
                                    <div class="invalid-feedback" id="error-price"></div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label" for="stock">Stock <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" id="stock" min="0" placeholder="0" type="number"/>
                                    <div class="invalid-feedback" id="error-stock"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="minStock">Stock Mínimo <span
                                            class="text-danger">*</span></label>
                                    <input class="form-control" id="minStock" min="0" placeholder="0" type="number"/>
                                    <div class="invalid-feedback" id="error-minStock"></div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="expirationDate">Fecha de Expiración</label>
                                    <input class="form-control" id="expirationDate" type="date"/>
                                    <div class="invalid-feedback" id="error-expirationDate"></div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="state">Estado <span class="text-danger">*</span></label>

                                <select aria-disabled="true"
                                        class="form-select"
                                        id="state"
                                        name="state"
                                        style="pointer-events: none; background-color: #e9ecef;"
                                        tabindex="-1">

                                    <option selected value="ALL">Seleccione</option>
                                    <option th:each="estado:${estados}"
                                            th:text="${estado.description}"
                                            th:value="${estado}">
                                    </option>
                                </select>

                                <small class="text-muted">El estado se calcula según el stock.</small>
                                <div class="invalid-feedback" id="error-state"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" for="imageFile">Imagen del Producto</label>
                                <input accept="image/*" class="form-control" id="imageFile"
                                       onchange="previewImage(event)"
                                       type="file"/>
                                <small class="text-muted">Formatos permitidos: JPG, PNG. Máx: 5MB</small>
                            </div>

                            <div class="mb-3 text-center">
                                <img alt="Vista Previa" class="img-thumbnail d-none" id="imagePreview"
                                     src="" style="max-width: 200px; max-height: 200px; object-fit: cover;">
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-success btn-lg" id="btnSubmit" type="submit">
                                    <span aria-hidden="true" class="spinner-border spinner-border-sm d-none"
                                          role="status"></span>
                                    Guardar Producto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/products';

        document.addEventListener("DOMContentLoaded", () => {
            verificarEdicion();
            actualizarEstadoVisual();

        });

        // 1. Detectar cambios en el input de STOCK
            document.getElementById('stock').addEventListener('input', function(e) {
            actualizarEstadoVisual(e.target.value);
        });

  function actualizarEstadoVisual() {
    // Obtenemos valores del DOM
    const stockVal = document.getElementById('stock').value;
    const minStockVal = document.getElementById('minStock').value; // Asegurate de tener este ID
    const stateSelect = document.getElementById('state');

    const stock = parseInt(stockVal) || 0;
    const minStock = parseInt(minStockVal) || 5; // Default 5 si está vacío

    // Umbral para "Casi Agotado" (Mismo que en Java)
    const umbralCasiAgotado = minStock + 10;

    let nuevoEstado = "";
    let claseColor = "";

    // LÓGICA ESPEJO (Idéntica a Java)
    if (stock <= 0) {
        nuevoEstado = "AGOTADO";
        claseColor = "text-danger"; // Rojo
    } else if (stock <= minStock) {
        nuevoEstado = "CON_STOCK_MINIMO";
        claseColor = "text-warning"; // Naranja/Amarillo oscuro
    } else if (stock <= umbralCasiAgotado) {
        nuevoEstado = "CASI_AGOTADO";
        claseColor = "text-info"; // Azulito o Amarillo claro
    } else {
        nuevoEstado = "DISPONIBLE";
        claseColor = "text-success"; // Verde
    }

    // Aplicar al select
    stateSelect.value = nuevoEstado;

    // Limpieza visual (Opcional: cambiar bordes o colores)
    stateSelect.className = 'form-select bg-light ' + claseColor;
}

// Escuchar cambios en AMBOS inputs
document.getElementById('stock').addEventListener('input', actualizarEstadoVisual);
document.getElementById('minStock').addEventListener('input', actualizarEstadoVisual);


        // 1. PREVIEW DE IMAGEN LOCAL
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        }

        // 2. VERIFICAR EDICIÓN
        async function verificarEdicion() {
            const pathParts = window.location.pathname.split('/');
            const id = pathParts[pathParts.length - 1];

            if (!isNaN(id) && id !== 'formProducts') {
                document.getElementById('formTitle').innerText = 'Editar Producto';
                const btn = document.getElementById('btnSubmit');
                btn.innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span> Actualizar Producto';

                document.getElementById('id').value = id;
                await cargarDatosProducto(id);
            }
        }

        // 3. CARGAR DATOS
        async function cargarDatosProducto(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (!response.ok) throw new Error("Error al cargar producto");
                const p = await response.json();

                // Llenar campos
                document.getElementById('code').value = p.code;
                document.getElementById('nameProducto').value = p.nameProducto;
                document.getElementById('description').value = p.description;
                document.getElementById('marca').value = p.marca;
                document.getElementById('price').value = p.price;
                document.getElementById('stock').value = p.stock;
                document.getElementById('minStock').value = p.minStock;
                document.getElementById('expirationDate').value = p.expirationDate; // Formato YYYY-MM-DD

                const stateInput = document.getElementById('state');
                if(stateInput){
                    stateInput.value= p.state;
                }

                actualizarEstadoVisual(p.stock);


                // Manejo de Imagen existente
                if (p.image) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = p.image;
                    preview.classList.remove('d-none');
                    document.getElementById('currentImageUrl').value = p.image;
                }

            } catch (error) {
                console.error(error);
                mostrarErrorGlobal("No se pudieron cargar los datos del producto");
            }
        }

        // 4. ENVIAR FORMULARIO (FormData para Archivos)
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            limpiarErrores();
            mostrarCargando(true);

            const id = document.getElementById('id').value;
            const esEdicion = !!id;

            // --- AQUÍ ESTÁ LA MAGIA: FormData ---
            const formData = new FormData();

            // Agregamos los campos de texto
            // Nota: Los nombres ("code", "nameProducto") deben coincidir con tu DTO o Entidad Java
            formData.append('code', document.getElementById('code').value);
            formData.append('nameProducto', document.getElementById('nameProducto').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('marca', document.getElementById('marca').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('stock', document.getElementById('stock').value);
            formData.append('minStock', document.getElementById('minStock').value);
            formData.append('expirationDate', document.getElementById('expirationDate').value);
            formData.append('state', document.getElementById('state').value);

            // Agregamos la imagen SOLO si el usuario seleccionó una nueva
            const imageInput = document.getElementById('imageFile');
            if (imageInput.files[0]) {
                formData.append('imageFile', imageInput.files[0]);
            }

            const url = esEdicion ? `${API_URL}/${id}` : API_URL;
            const method = esEdicion ? 'PUT' : 'POST';

            try {
                // NOTA: Al usar FormData, NO se pone el header 'Content-Type': 'application/json'
                // El navegador lo detecta automáticamente como multipart/form-data
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (response.ok) {
                    window.location.href = '/products';
                } else {
                    const errorData = await response.json();
                    if (response.status === 400 && errorData.errors) {
                        mostrarErroresValidacion(errorData.errors);
                    } else {
                        mostrarErrorGlobal("Error del servidor: " + response.status);
                    }
                }
            } catch (error) {
                console.error(error);
                mostrarErrorGlobal("Error de conexión");
            } finally {
                mostrarCargando(false);
            }
        });

        // Utilidades (Mismas que en Usuarios)
        function limpiarErrores() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.innerText = '');
            document.getElementById('globalError').classList.add('d-none');
        }

        function mostrarErroresValidacion(errors) {
            if (Array.isArray(errors)) {
                errors.forEach(err => {
                    const input = document.getElementById(err.field);
                    if (input) {
                        input.classList.add('is-invalid');
                        const feedback = document.getElementById(`error-${err.field}`);
                        if (feedback) feedback.innerText = err.defaultMessage;
                    }
                });
            } else {
                 for (const [field, msg] of Object.entries(errors)) {
                    const input = document.getElementById(field);
                    if (input) {
                        input.classList.add('is-invalid');
                        const feedback = document.getElementById(`error-${field}`);
                        if (feedback) feedback.innerText = msg;
                    }
                 }
            }
            mostrarErrorGlobal("Corrija los errores en el formulario");
        }

        function mostrarErrorGlobal(msg) {
            const alerta = document.getElementById('globalError');
            alerta.innerText = msg;
            alerta.classList.remove('d-none');
        }

        function mostrarCargando(activo) {
            const btn = document.getElementById('btnSubmit');
            const spinner = btn.querySelector('.spinner-border');
            if (activo) {
                btn.disabled = true;
                spinner.classList.remove('d-none');
            } else {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }
    </script>
</div>
</body>
</html>